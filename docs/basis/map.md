# MAP推定(最大事後確率推定)

## 背景

最尤推定において、試行回数が少ないとき(データ数が少ないとき)過学習を起こしてしまう。  
たとえば、サイコロの例で、3が1回出た場合のみ(試行回数1回)を考えたとき、最尤推定した結果として、絶対に3が出るという推定結果になる。

一般的に、未知のデータを予測するためには、汎化性能が必要で過学習の状況は良くない。

MAP(maximum a posteriori)推定（最大事後確率推定）を用いることで、最尤推定より汎化性能の高い推定ができる。

## 概要

データ$D$を観測した後のパラメータ$\mu$の確率(事後確率)が最大となるパラメータを見つける。  
事後確率はベイズの定理より、

$$
p(\mu|D, a) = \frac{p(\mu|a)p(D|\mu)}{p(D|a)}
$$

分母はパラメータ$\mu$に依存しないため、分子のみ考え、対数尤度$L(\mu)$は

$$
L(\mu) = \log p(D|\mu) + \log p(\mu|a)
$$

事前確率 $p(\mu|a)$ には任意の確率分布を用いることができる。  
ただし、一般的に **共役事前分布**(conjugate prior)を用いると計算が楽。

**共役事前分布** とは、事後確率と事前確率の分布が同じ形になる事前分布のこと。

共役事前分布が存在する分布

- カテゴリ分布
- 多項分布
- ポアソン分布
- 正規分布

などの指数型分布族のもの。

カテゴリ分布の共役事前分布はディリクレ分布。  

$$
\text{Dir}(\mu|a) = \frac{\Gamma(\sum^K_{k=1} a_k)}{\prod^K_{k=1} \Gamma(a_k)} \prod^K_{k=1} \mu^{a_k-1}_k \\
(a_k > 0 : パラメータ)
$$

これを事前分布として代入していく。

$$
\begin{align}
& \underset{\mu}{\text{argmax}}[\log p(D|\mu) + \log p(\mu|a)] \\
&= \underset{\mu}{\text{argmax}}[\log \prod^K_{k=1} \mu^{m_k}_k + \log \frac{\Gamma(aK)}{\Gamma(a)^K} \prod^K_{k=1} \mu^{a-1}_k] \\
&= \underset{\mu}{\text{argmax}}[\sum^K_{k=1}\log \mu^{m_k}_k + \sum^K_{k=1} \log \mu^{a-1}_k + Const.] \\
&= \underset{\mu}{\text{argmax}} \sum^K_{k=1} (m_k + a -1)\log \mu_k
\end{align}
$$

最尤推定のときと同様に、ラグランジュの未定乗数法を用いて解くと、

$$
\mu_k = \frac{m_k+a-1}{N+(a-1)K}
$$

